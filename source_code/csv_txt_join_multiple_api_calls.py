#Author: Megan Toinga

import os
import logging

import pandas as pd

def get_list_of_sequence_from_csv(path):
    cwd = os.getcwd()
    complete_path = os.path.join(cwd,path)
    print("Analyzing files under path:", complete_path)
    api_call_sequences = []

    for filename in os.listdir(complete_path):
        rows = []
        data_frame = pd.read_csv(os.path.join(complete_path, filename)).dropna()

        for index, row in data_frame.iterrows():
            rows.append(row["api"])

        api_calls = ''
        api_calls = ','.join(rows)
        api_call_sequences.append(api_calls)
        
    return api_call_sequences

def create_txt_sequence_file(api_call_sequences,type="none"):
    try:
        with open(f'./sequences/results/api_sequences_{type}.txt', "w+", encoding="utf-8") as writer:
            for sequence in api_call_sequences:
                writer.write(str(sequence) + '\n')
        writer.close()
        print(f"Created api_sequences_{type}.txt successfully..")
        logging.info(f"Created api_sequences_{type}.txt successfully..")
    except Exception as ex:
        print("Error while creating file:" + str(ex))
        logging.error("Error while creating file:" + str(ex))

sequences = get_list_of_sequence_from_csv("ENGR6991-ReverseEngineeringOnEducationalMalware\\system_calls\\malicious_cryptominer_calls")
create_txt_sequence_file(sequences,"crypto")